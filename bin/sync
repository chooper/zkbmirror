#!/usr/bin/env ruby

require 'rubygems'
require 'logger'
require 'json'
require 'excon'
require 'sequel'
require 'diskcached'

$logger = Logger.new(STDOUT)
$logger.level = Logger::INFO

$cache = Diskcached.new

def database
  $conn ||= Sequel.connect("sqlite://kills.db", :logger => $logger)
end

def init_database
  database.create_table :kills do
    column :kill_id,            String,   primary_key: true
    column :kill_time,          Time
    column :victim,             String
    column :character_id,       String
    column :character_name,     String
    column :corporation_id,     String
    column :corporation_name,   String
    column :alliance_id,        String
    column :alliance_name,      String
  end

  database.create_table :kill_attackers do
    foreign_key :kill_id, :kills
    column :character_id,       String
    column :character_name,     String
    column :corporation_id,     String
    column :corporation_name,   String
    column :alliance_id,        String
    column :alliance_name,      String
  end
  rescue Sequel::DatabaseError
    nil
end

def interesting_ships
  [
    32250,  # sbu
    32226,  # tcu
    32458,  # ihub
  ]
end

def regions
  url = "http://www.evedata.org/JSON/marketRegionList.cgi"
  $cache.cache(url) do
    response = Excon.get(url)
    decode(response.body).collect { |o| o["regionID"] }
  end
end

def inflate(string)
  Zlib::GzipReader.new(StringIO.new(string)).read
  rescue Zlib::GzipFile::Error
    string
end

def decode(string)
  JSON.parse(string)
end

def save_kill(kill)
  database.transaction do

    exists = database[:kills][:kill_id => kill['killID']]
    raise Sequel::Rollback if exists

    database[:kills].insert(
      :kill_id            => kill['killID'],
      :kill_time          => kill['killTime'],
      :victim             => kill['victim']['victim'],
      :character_id       => kill['victim']['characterID'],
      :character_name     => kill['victim']['characterName'],
      :corporation_id     => kill['victim']['corporationID'],
      :corporation_name   => kill['victim']['corporationName'],
      :alliance_id        => kill['victim']['allianceID'],
      :alliance_name      => kill['victim']['allianceName'])
    
    kill['attackers'].each do |attacker|
      database[:kill_attackers].insert(
        :kill_id            => kill['killID'],
        :character_id       => attacker['characterID'],
        :character_name     => attacker['characterName'],
        :corporation_id     => attacker['corporationID'],
        :corporation_name   => attacker['corporationName'],
        :alliance_id        => attacker['allianceID'],
        :alliance_name      => attacker['allianceName'])
    end
  end
end

def zkb_request(params)
  url = "https://zkillboard.com/api/#{params.to_a.join('/')}/"
  # protip: you can bypass cache enforcement by joining/appending alliance IDs

  $cache.cache(url) do
    response = Excon.get(url,
      :debug   => true,
      :headers =>
        {
          'User-Agent'        => 'Maintainer: subfrowns <subfrowns@gmail.com>',
          'Accept-Encoding'   => 'gzip',
        }
    )
    {:status => response.status, :headers => response.headers, :body => inflate(response.body)}
  end
end

def main
  init_database
  regions.each do |regionID|
    interesting_ships.each do |shipTypeID|
      response = zkb_request(pastSeconds: 86400, regionID: regionID, shipTypeID: shipTypeID)
      if response[:status] == 200
        body = decode(response[:body])
        next if body.nil? or body.empty?
        body.each { |kill| save_kill(kill) }
      end
    end
  end
end

main

